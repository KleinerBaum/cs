from __future__ import annotations
from typing import Any

LANG_DE = "de"
LANG_EN = "en"
SUPPORTED_LANGS = (LANG_DE, LANG_EN)

_STRINGS: dict[str, dict[str, str]] = {
    LANG_DE: {
        "app.tagline": "Dynamischer Informationsgewinnungs-Flow für Anforderungsprofile & Job-Ads",
        "sidebar.title": "Einstellungen",
        "sidebar.language": "Sprache",
        "sidebar.theme": "Theme",
        "sidebar.model": "LLM-Modell",
        "sidebar.model_help": "Standard: {0}. Per Sidebar umschalten oder via OPENAI_MODEL setzen.",
        "sidebar.use_esco": "ESCO-Vorschläge aktivieren",
        "sidebar.auto_ai": "AI-Follow-ups automatisch vorschlagen",
        "sidebar.reset": "Session zurücksetzen",
        "sidebar.overview": "Eingabe-Übersicht",
        "sidebar.jump_to_step": "Zum Schritt",
        "sidebar.subtitle": "Passe Anzeige, Sprache und Helfer nach Bedarf an.",
        "sidebar.section.display": "Anzeige & Sprache",
        "sidebar.section.assistants": "Automatische Helfer",
        "sidebar.section.actions": "Aktionen",
        "theme.light": "Hell",
        "theme.dark": "Dunkel",
        "errors.no_api_key": "OpenAI API-Schlüssel nicht konfiguriert! Bitte OPENAI_API_KEY als Umgebungsvariable oder in den Streamlit-Secrets setzen, bevor du die App startest.",
        "intake.title": "1) Ausgangsbasis importieren",
        "intake.subtitle": "URL eingeben, PDF/DOCX hochladen oder Text einfügen, um Felder automatisch zu prefillen.",
        "intake.url": "Job-Ad URL (optional)",
        "intake.file": "PDF/DOCX Upload (optional)",
        "intake.paste": "Stellenausschreibung einfügen (optional)",
        "intake.paste_placeholder": "Vollständigen Stellenausschreibungstext hier einfügen …",
        "intake.process": "Importieren & Extrahieren",
        "intake.source_preview": "Extrahierter Text (Vorschau)",
        "intake.tip": "Tipp: Wenn du nichts importierst, kannst du direkt manuell starten (oben Step auswählen).",
        "intake.need_source": "Bitte URL, Datei oder Text angeben (oder einfach weiterklicken und manuell ausfüllen).",
        "intake.single_source": "Bitte nur eine Quelle gleichzeitig nutzen (URL, Upload oder Freitext).",
        "intake.import_failed": "Import fehlgeschlagen",
        "intake.no_openai_key": "Kein OpenAI API Key gesetzt – Import ist erfolgt, aber ohne LLM-Extraktion.",
        "intake.extract_done": "Extraktion abgeschlossen.",
        "intake.updated_fields": "Aktualisierte Felder",
        "intake.extract_failed": "LLM-Extraktion fehlgeschlagen",
        "intake.invalid_request": "LLM-Anfrage ungültig. KI-Konfiguration prüfen: Modell/Parameter ungültig.",
        "intake.retryable_error": "Netzwerk- oder Timeout-Fehler. Bitte erneut versuchen oder kurz warten (Backoff).",
        "progress.missing_required": "Fehlende Pflichtfelder",
        "progress.ready": "Alle Pflichtfelder sind gefüllt.",
        "step.missing_in_step": "Fehlt in diesem Schritt",
        "nav.prev": "Zurück",
        "nav.next": "Weiter",
        "step.company": "Unternehmen",
        "step.team": "Team",
        "step.framework": "Rahmenbedingungen",
        "step.tasks": "Aufgaben",
        "step.skills": "Skills",
        "step.benefits": "Benefits",
        "step.process": "Recruiting Prozess",
        "step.review": "Review & Export",
        "ui.more_details": "Mehr Details (optional)",
        "ui.ai_suggest": "AI: Vorschläge generieren",
        "ui.translate_to_en": "AI: Englisch-Versionen erzeugen",
        "ui.translate_done": "Englisch-Felder aktualisiert",
        "ui.translate_failed": "Übersetzung fehlgeschlagen",
        "ui.translate_hint": "EN-Felder werden genutzt, wenn du UI/Output auf Englisch stellst.",
        "ui.ai_hint": "AI-Follow-ups erscheinen nur bei Lücken/Unsicherheiten und bleiben optional.",
        "ui.ai_followups_title": "AI-Follow-ups",
        "ui.boolean_yes": "Ja",
        "ui.boolean_no": "Nein",
        "ui.generate_role_summary": "Rollenbeschreibung generieren",
        "ui.role_summary_updated": "Rollenbeschreibung aktualisiert",
        "ui.generate_tasks": "Tasks generieren",
        "ui.tasks_updated": "Aufgabenliste aktualisiert",
        "ui.suggest_core_skills": "Core Skills vorschlagen",
        "ui.suggest_nice_skills": "Nice-to-have Skills vorschlagen",
        "ui.core_skills_updated": "Pflicht-Skills aktualisiert",
        "ui.nice_skills_updated": "Optionale Skills aktualisiert",
        "validation.required": "Pflichtfeld bitte ausfüllen.",
        "errors.llm_call_failed": "LLM-Aufruf fehlgeschlagen",
        "ai.followups_done": "AI-Follow-ups erstellt",
        "ai.followups_failed": "AI-Follow-ups fehlgeschlagen",
        "ai.suggestions_done": "Auto-Vorschläge ergänzt: {0}",
        "ui.esco_search": "ESCO: Suche",
        "ui.esco_pick": "ESCO: Treffer auswählen",
        "ui.esco_apply_skills": "ESCO-Skills übernehmen",
        "ui.esco_insert_hard": "In Hard Skills übernehmen",
        "ui.empty": "—",
        "esco.title": "ESCO",
        "esco.query": "ESCO Suchbegriff",
        "esco.skills_select": "Skills (zum Hinzufügen auswählen)",
        "esco.caption": "ESCO liefert standardisierte Occupations/Skills (EU).",
        "esco.lang_hint": "Suche auf {0}",
        "esco.apply_hint": "Die Auswahl wird in die Pflicht-Hard-Skills eingefügt.",
        "esco.apply_success": "ESCO-Skills wurden in die Pflicht-Hard-Skills übernommen.",
        "esco.merge_success": "Skills wurden in 'Hard Skills optional' ergänzt.",
        "esco.error": "ESCO Fehler",
        "review.title": "Ergebnis",
        "review.profile_json": "Profil-JSON (NeedAnalysisProfile)",
        "review.job_ad": "Job-Ad Entwurf",
        "review.download_json": "JSON herunterladen",
        "review.download_md": "Markdown herunterladen",
        "review.download_docx": "DOCX herunterladen",
        "review.edit_hint": "Du kannst den Entwurf unten bearbeiten, bevor du exportierst.",
        "review.provenance_title": "Provenance",
        "review.provenance_extracted": "Extracted",
        "review.provenance_ai": "AI-Vorschläge",
        "salary.section_title": "Gehaltsprognose",
        "salary.section_hint": "Wähle, welche Profildaten in die Berechnung einfließen sollen. Werte kannst du im Profil oben ergänzen oder ändern.",
        "salary.selection_hint": "Die Prognose wird nur mit den markierten Feldern berechnet.",
        "salary.calculate": "Gehaltsprognose berechnen",
        "salary.no_values": "Keine verwertbaren Werte vorhanden – bitte Felder markieren und ausfüllen.",
        "salary.prediction_done": "Gehaltsprognose aktualisiert",
        "salary.result_title": "Prognose",
        "salary.range_min": "Unteres Band",
        "salary.range_max": "Oberes Band",
        "salary.used_parameters": "Verwendete Parameter",
        "salary.breakdown_title": "Herleitung",
        "salary.breakdown.base": "Basisband (Seniorität: {0})",
        "salary.breakdown.factor": "{0}: {1} (Wert: {2})",
        "salary.chart_title": "Gehaltsband (Visualisierung)",
        "salary.chart_caption": "Das Diagramm zeigt Untergrenze, Mittelwert und Obergrenze der aktuellen Prognose.",
        "salary.chart.min": "Minimum",
        "salary.chart.avg": "Durchschnitt",
        "salary.chart.max": "Maximum",
        "salary.chart.axis_label": "Band",
        "salary.chart.salary_axis": "Gehalt",
        "salary.narrative_title": "Erläuterung",
        "salary.narrative_hint": "Kurze, automatisch generierte Begründung der Prognose – basierend auf den gewählten Parametern.",
        "salary.narrative_fallback": "Die Prognose basiert auf dem Senioritäts-Basisband und den gewählten Anpassungen.",
        "salary.narrative_bullet": "• {0}",
        "salary.factor.seniority": "Seniorität",
        "salary.factor.city": "Standort",
        "salary.factor.work_policy": "Arbeitsmodell",
        "salary.factor.remote_scope": "Remote-Umfang",
        "salary.factor.employment_type": "Anstellungsart",
        "salary.factor.contract_type": "Vertragsart",
        "salary.factor.industry": "Branche",
        "salary.factor.company_size": "Unternehmensgröße",
        "salary.factor.currency": "Währung",
        "provenance.user": "User",
        "provenance.extracted": "Extracted",
        "provenance.ai_suggestion": "AI suggestion",
        "field.generic": "Wert",
    },
    LANG_EN: {
        "app.tagline": "Dynamic requirement-gathering flow for job requisitions & job ads",
        "sidebar.title": "Settings",
        "sidebar.language": "Language",
        "sidebar.theme": "Theme",
        "sidebar.model": "LLM model",
        "sidebar.model_help": "Default: {0}. Switch in the sidebar or set OPENAI_MODEL.",
        "sidebar.use_esco": "Enable ESCO suggestions",
        "sidebar.auto_ai": "Suggest AI follow-ups automatically",
        "sidebar.reset": "Reset session",
        "sidebar.overview": "Input overview",
        "sidebar.jump_to_step": "Go to step",
        "sidebar.subtitle": "Adjust display, language, and assistants as needed.",
        "sidebar.section.display": "Display & language",
        "sidebar.section.assistants": "Automated assistants",
        "sidebar.section.actions": "Actions",
        "theme.light": "Light",
        "theme.dark": "Dark",
        "errors.no_api_key": "OpenAI API key is not configured! Please set OPENAI_API_KEY as an environment variable or in Streamlit secrets before starting the app.",
        "intake.title": "1) Import a starting point",
        "intake.subtitle": "Paste a URL, upload a PDF/DOCX, or drop the text directly to prefill fields.",
        "intake.url": "Job ad URL (optional)",
        "intake.file": "PDF/DOCX upload (optional)",
        "intake.paste": "Paste job ad text (optional)",
        "intake.paste_placeholder": "Insert the full job ad text here …",
        "intake.process": "Import & extract",
        "intake.source_preview": "Extracted text (preview)",
        "intake.tip": "Tip: If you don't import anything, you can start manually (select a step above).",
        "intake.need_source": "Please provide a URL, file, or text (or just continue and fill everything manually).",
        "intake.single_source": "Please use only one source at a time (URL, upload, or pasted text).",
        "intake.import_failed": "Import failed",
        "intake.no_openai_key": "No OpenAI API key set – import succeeded, but without LLM extraction.",
        "intake.extract_done": "Extraction finished.",
        "intake.updated_fields": "Updated fields",
        "intake.extract_failed": "LLM extraction failed",
        "intake.invalid_request": "LLM request invalid. Check AI configuration: model/parameters are invalid.",
        "intake.retryable_error": "Network or timeout error. Please retry or wait briefly (backoff).",
        "progress.missing_required": "Missing required fields",
        "progress.ready": "All required fields are filled.",
        "step.missing_in_step": "Missing in this step",
        "nav.prev": "Back",
        "nav.next": "Next",
        "step.company": "Company",
        "step.team": "Team",
        "step.framework": "Framework",
        "step.tasks": "Responsibilities",
        "step.skills": "Skills",
        "step.benefits": "Benefits",
        "step.process": "Recruiting process",
        "step.review": "Review & Export",
        "ui.more_details": "More details (optional)",
        "ui.ai_suggest": "AI: Generate suggestions",
        "ui.translate_to_en": "AI: Generate English versions",
        "ui.translate_done": "English fields updated",
        "ui.translate_failed": "Translation failed",
        "ui.translate_hint": "EN fields will be used if you switch the UI/output to English.",
        "ui.ai_hint": "AI follow-ups appear only for gaps/uncertainties and are optional.",
        "ui.ai_followups_title": "AI follow-ups",
        "ui.boolean_yes": "Yes",
        "ui.boolean_no": "No",
        "ui.generate_role_summary": "Generate role summary",
        "ui.role_summary_updated": "Role summary updated",
        "ui.generate_tasks": "Generate tasks",
        "ui.tasks_updated": "Tasks updated",
        "ui.suggest_core_skills": "Suggest core skills",
        "ui.suggest_nice_skills": "Suggest nice-to-have skills",
        "ui.core_skills_updated": "Required skills updated",
        "ui.nice_skills_updated": "Optional skills updated",
        "validation.required": "Please fill out this required field.",
        "errors.llm_call_failed": "LLM call failed",
        "ai.followups_done": "AI follow-ups created",
        "ai.followups_failed": "AI follow-ups failed",
        "ai.suggestions_done": "Auto-suggested fields: {0}",
        "ui.esco_search": "ESCO: Search",
        "ui.esco_pick": "ESCO: Select an occupation",
        "ui.esco_apply_skills": "Apply ESCO skills",
        "ui.esco_insert_hard": "Insert into Hard Skills",
        "ui.empty": "—",
        "esco.title": "ESCO",
        "esco.query": "ESCO search query",
        "esco.skills_select": "Skills (select to add)",
        "esco.caption": "ESCO provides standardized occupations/skills (EU).",
        "esco.lang_hint": "Querying in {0}",
        "esco.apply_hint": "Selected skills will be added to required hard skills.",
        "esco.apply_success": "ESCO skills inserted into required hard skills.",
        "esco.merge_success": "Skills added to 'Hard Skills optional'.",
        "esco.error": "ESCO error",
        "review.title": "Result",
        "review.profile_json": "Profile JSON (NeedAnalysisProfile)",
        "review.job_ad": "Job ad draft",
        "review.download_json": "Download JSON",
        "review.download_md": "Download Markdown",
        "review.download_docx": "Download DOCX",
        "review.edit_hint": "You can edit the draft below before exporting.",
        "review.provenance_title": "Provenance",
        "review.provenance_extracted": "Extracted",
        "review.provenance_ai": "AI suggestions",
        "salary.section_title": "Salary prediction",
        "salary.section_hint": "Pick the profile fields that should drive the estimate. You can edit the values in the steps above.",
        "salary.selection_hint": "Only the checked fields are used for the prediction.",
        "salary.calculate": "Calculate salary prediction",
        "salary.no_values": "No usable values found – please select and fill the relevant fields.",
        "salary.prediction_done": "Salary prediction updated",
        "salary.result_title": "Prediction",
        "salary.range_min": "Lower bound",
        "salary.range_max": "Upper bound",
        "salary.used_parameters": "Applied parameters",
        "salary.breakdown_title": "Rationale",
        "salary.breakdown.base": "Baseline (seniority: {0})",
        "salary.breakdown.factor": "{0}: {1} (value: {2})",
        "salary.chart_title": "Salary band (visual)",
        "salary.chart_caption": "The chart displays the lower bound, midpoint, and upper bound for the current prediction.",
        "salary.chart.min": "Minimum",
        "salary.chart.avg": "Average",
        "salary.chart.max": "Maximum",
        "salary.chart.axis_label": "Band",
        "salary.chart.salary_axis": "Salary",
        "salary.narrative_title": "Explanation",
        "salary.narrative_hint": "Short, automatically generated rationale based on the selected parameters.",
        "salary.narrative_fallback": "The estimate combines the seniority baseline with the applied adjustments.",
        "salary.narrative_bullet": "• {0}",
        "salary.factor.seniority": "Seniority",
        "salary.factor.city": "Location",
        "salary.factor.work_policy": "Work policy",
        "salary.factor.remote_scope": "Remote scope",
        "salary.factor.employment_type": "Employment type",
        "salary.factor.contract_type": "Contract type",
        "salary.factor.industry": "Industry",
        "salary.factor.company_size": "Company size",
        "salary.factor.currency": "Currency",
        "provenance.user": "User",
        "provenance.extracted": "Extracted",
        "provenance.ai_suggestion": "AI suggestion",
        "field.generic": "Value",
    },
}


def t(lang: str, key: str, *fmt_args: Any) -> str:
    """Translate a given key into the selected language, formatting if needed."""
    lang_map = _STRINGS.get(lang)
    text = (lang_map.get(key) if lang_map else None) or _STRINGS[LANG_EN].get(
        key, str(key)
    )
    return text if not fmt_args else text.format(*fmt_args)


def as_lang(lang_raw: str) -> str:
    """Return a supported language code ('de' or 'en'), defaulting to 'de'."""
    return lang_raw if lang_raw in SUPPORTED_LANGS else LANG_DE


def option_label(lang: str, group: str, value: str) -> str:
    """Friendly label for enumerated option values, based on language."""
    # Map stable values to display labels
    mapping = {
        "work_policy": {
            "onsite": {"de": "Onsite", "en": "Onsite"},
            "hybrid": {"de": "Hybrid", "en": "Hybrid"},
            "remote": {"de": "Remote", "en": "Remote"},
        },
        "employment_type": {
            "full_time": {"de": "Vollzeit", "en": "Full-time"},
            "part_time": {"de": "Teilzeit", "en": "Part-time"},
            "contractor": {"de": "Freelance", "en": "Contractor"},
            "intern": {"de": "Praktikum", "en": "Internship"},
        },
        "contract_type": {
            "permanent": {"de": "Unbefristet", "en": "Permanent"},
            "fixed_term": {"de": "Befristet", "en": "Fixed-term"},
        },
        "seniority": {
            "junior": {"de": "Junior", "en": "Junior"},
            "mid": {"de": "Mid-Level", "en": "Mid-Level"},
            "senior": {"de": "Senior", "en": "Senior"},
            "lead": {"de": "Lead", "en": "Lead"},
            "head": {"de": "Head of ...", "en": "Head of ..."},
            "c_level": {"de": "C-Level", "en": "C-Level"},
        },
        "salary_period": {
            "year": {"de": "Jahr", "en": "year"},
            "month": {"de": "Monat", "en": "month"},
            "hour": {"de": "Stunde", "en": "hour"},
        },
    }
    return mapping.get(group, {}).get(str(value), {}).get(lang, str(value))
